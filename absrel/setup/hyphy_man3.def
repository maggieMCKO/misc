Bootstrap: docker
From: ubuntu:20.04

%labels
    MAINTAINER Maggie Ko <mengching.ko@bi.mpg.de>
    VERSION 2.5.69 Commit f814458
    APPLICATION HyPhy
    AUTHOR maggieMCKO

%help
    This container contains HyPhy (Hypothesis Testing using Phylogenies)
    built from source following the official guidelines from https://github.com/veg/hyphy
    
    Usage:
    $ apptainer run hyphy.sif [args]
    $ apptainer exec hyphy.sif hyphy [args]
    
    To mount data for analysis:
    $ apptainer run -B /path/to/your/data:/data hyphy.sif

%post
    # Set timezone
    export DEBIAN_FRONTEND=noninteractive
    export TZ=Europe/Berlin  
    ln -snf /usr/share/zoneinfo/$TZ /etc/localtime && echo $TZ > /etc/timezone

    # Update system
    apt-get update
    
    # Install required dependencies
    apt-get install -y --no-install-recommends \
        build-essential \
        cmake \
        gcc \
        g++ \
        libcurl4-openssl-dev \
        git \
        ca-certificates \
        libgomp1 \
        libomp-dev \
        openmpi-bin \
        libopenmpi-dev \
        python3 \
        python3-pip \
        wget \
        && rm -rf /var/lib/apt/lists/*
        
    # Clone HyPhy repository and checkout specific version for reproducibility
    cd /opt
    git clone https://github.com/veg/hyphy.git
    cd hyphy
    
    # Pin to the specific commit mentioned in the labels
    git checkout f814458  # Pin to specific commit matching VERSION 2.5.69
    
    # Get version information and save to file for reference
    HYPHY_VERSION=$(git describe --tags --abbrev=0 2>/dev/null || echo "unknown")
    HYPHY_COMMIT=$(git rev-parse --short HEAD)
    echo "Built HyPhy version: $HYPHY_VERSION (commit: $HYPHY_COMMIT)" > /opt/hyphy_version_info.txt
    
    # Build HyPhy
    cmake .
    make -j $(nproc) MP
    make -j $(nproc) MPI
    make install
    
    # Clone hyphy-analyses repository
    cd /opt
    git clone https://github.com/veg/hyphy-analyses.git
    
    # Install Python dependencies for analysis scripts
    python3 -m pip install --upgrade pip
    python3 -m pip install numpy scipy matplotlib biopython
    
    # Create a directory for data
    mkdir -p /data

%environment
    export LC_ALL=C
    # Add HyPhy to the path
    export PATH=$PATH:/usr/local/bin
    # Set environment variable for hyphy-analyses
    export HYPHY_ANALYSES_PATH=/opt/hyphy-analyses

%runscript
    exec hyphy "$@"